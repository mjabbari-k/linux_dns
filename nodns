#!/bin/bash
# nodns - revert DNS to automatic using NetworkManager

set -euo pipefail

# Detect active interface
IFACE=$(ip route show default | awk '{print $5}' | head -n 1)

# Find connection name reliably
CONNECTED_CONNECTION=$(nmcli -t -f NAME,DEVICE connection show --active \
    | awk -F: -v iface="$IFACE" '$2==iface {print $1}' | head -n 1)

if [ -z "$CONNECTED_CONNECTION" ]; then
    CONNECTED_CONNECTION=$(nmcli -t -f NAME,DEVICE connection show \
        | awk -F: -v iface="$IFACE" '$2==iface {print $1}' | head -n 1)
fi

if [ -z "$CONNECTED_CONNECTION" ]; then
    echo "ERROR: could not find active NetworkManager connection."
    exit 1
fi

echo "Detected active connection: \"$CONNECTED_CONNECTION\""
echo "Interface: $IFACE"
echo "Resetting DNS to automatic..."

# Correct reset sequence for your NM version
nmcli connection modify "$CONNECTED_CONNECTION" ipv4.ignore-auto-dns no
nmcli connection modify "$CONNECTED_CONNECTION" ipv4.dns ""
nmcli connection modify "$CONNECTED_CONNECTION" ipv4.dns-search ""

# Apply changes using same logic as your working setdns
nmcli connection down "$CONNECTED_CONNECTION" && nmcli connection up "$CONNECTED_CONNECTION"

echo "âœ… DNS reverted to automatic for \"$CONNECTED_CONNECTION\""
