#!/bin/sh
# nodns - revert DNS settings on the active NetworkManager connection.
# Safe for connection names containing spaces and ':' (nmcli -t escaping handled).
set -e

detect_dev() {
  ip route get 1.1.1.1 2>/dev/null | awk '/dev/ {for(i=1;i<=NF;i++) if($i=="dev") {print $(i+1); exit}}'
}

unescape_nmcli() {
  printf '%s' "$1" | sed 's/\\:/:/g'
}

DEV="$(detect_dev)"
[ -n "$DEV" ] || { echo "Could not detect default interface."; exit 1; }

CONN_RAW="$(nmcli -t -f NAME,DEVICE connection show --active | awk -F: -v dev="$DEV" '$2==dev{print $1; exit}')"
CONN="$(unescape_nmcli "$CONN_RAW")"

if [ -z "$CONN" ]; then
  CONN_RAW="$(nmcli -t -f NAME connection show --active | head -n1)"
  CONN="$(unescape_nmcli "$CONN_RAW")"
fi

[ -n "$CONN" ] || { echo "No active NetworkManager connection found."; exit 1; }

TYPE="$(nmcli -g connection.type connection show "$CONN" 2>/dev/null || true)"
MODE="$(nmcli -g 802-11-wireless.mode connection show "$CONN" 2>/dev/null || true)"
if [ "$TYPE" = "wifi" ] && [ "$MODE" = "ap" ]; then
  echo "Active connection '$CONN' appears to be Wiâ€‘Fi AP/hotspot mode. Skipping DNS changes."
  exit 0
fi

nmcli connection modify "$CONN" ipv4.ignore-auto-dns no
nmcli connection modify "$CONN" -ipv4.dns
nmcli connection up "$CONN" >/dev/null 2>&1 || true

echo "DNS reset to automatic for connection: $CONN"
