#!/bin/sh
# nodns - reset DNS to automatic for the active NetworkManager connection.
# Fast and non-interactive.
set -e

detect_dev() {
  ip route get 1.1.1.1 2>/dev/null | awk '/dev/ {for(i=1;i<=NF;i++) if($i=="dev") {print $(i+1); exit}}'
}

unescape_nmcli() {
  # nmcli -t escapes ':' as '\:'
  printf '%s' "$1" | sed 's/\\:/:/g'
}

get_active_conn() {
  DEV="$(detect_dev)"
  [ -n "$DEV" ] || return 1

  CONN_RAW="$(nmcli -t -f NAME,DEVICE connection show --active | awk -F: -v dev="$DEV" '$2==dev{print $1; exit}')"
  CONN="$(unescape_nmcli "$CONN_RAW")"

  if [ -z "$CONN" ]; then
    CONN_RAW="$(nmcli -t -f NAME connection show --active | head -n1)"
    CONN="$(unescape_nmcli "$CONN_RAW")"
  fi

  [ -n "$CONN" ] || return 1
  printf '%s' "$CONN"
  return 0
}

is_hotspot_ap() {
  CONN="$1"
  TYPE="$(nmcli -g connection.type connection show "$CONN" 2>/dev/null || true)"
  MODE="$(nmcli -g 802-11-wireless.mode connection show "$CONN" 2>/dev/null || true)"
  [ "$TYPE" = "wifi" ] && [ "$MODE" = "ap" ]
}

CONN="$(get_active_conn)" || { echo "Error: No active NetworkManager connection found."; exit 1; }

if is_hotspot_ap "$CONN"; then
  echo "Info: Active connection '$CONN' appears to be Wiâ€‘Fi AP/hotspot mode. Skipping DNS reset."
  exit 0
fi

# Reset DNS to automatic:
# - allow auto DNS again
# - clear any manually configured IPv4 DNS (set to empty string)
if nmcli connection modify "$CONN" ipv4.ignore-auto-dns no   && nmcli connection modify "$CONN" ipv4.dns ""; then
  nmcli connection up "$CONN" >/dev/null 2>&1 || true
  echo "OK: DNS reset to automatic for '$CONN'"
  exit 0
else
  echo "Error: Failed to reset DNS for '$CONN'"
  exit 1
fi
