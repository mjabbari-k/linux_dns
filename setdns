#!/bin/bash
# setdns - set DNS servers system-wide (NetworkManager or resolv.conf fallback)

if [ $# -ne 2 ]; then
    echo "Usage: $0 <DNS1> <DNS2>"
    exit 1
fi

DNS1="$1"
DNS2="$2"

if command -v nmcli >/dev/null 2>&1; then
    CONNECTED_CONNECTION=$(nmcli -t -f NAME connection show --active | head -n 1)

    if [ -z "$CONNECTED_CONNECTION" ]; then
        IFACE=$(ip route show default 2>/dev/null | awk '{print $5}' | head -n 1)
        if [ -n "$IFACE" ]; then
            CONNECTED_CONNECTION=$(nmcli -t -f NAME,DEVICE connection show | grep ":$IFACE" | awk -F: '{print $1}' | head -n 1)
        fi
    fi

    if [ -n "$CONNECTED_CONNECTION" ]; then
        echo "Using NetworkManager connection: $CONNECTED_CONNECTION"
        nmcli connection modify "$CONNECTED_CONNECTION" ipv4.dns "$DNS1 $DNS2"
        nmcli connection modify "$CONNECTED_CONNECTION" ipv4.ignore-auto-dns yes
        nmcli connection down "$CONNECTED_CONNECTION" && nmcli connection up "$CONNECTED_CONNECTION"
        echo "DNS updated to $DNS1 and $DNS2"
        exit 0
    fi
fi

# Fallback to editing resolv.conf directly
if [ -w /etc/resolv.conf ]; then
    cp /etc/resolv.conf /etc/resolv.conf.backup.$(date +%s)
    {
        echo "# Generated by setdns script"
        echo "nameserver $DNS1"
        echo "nameserver $DNS2"
    } > /etc/resolv.conf
    echo "Updated /etc/resolv.conf with $DNS1 and $DNS2"
else
    echo "Error: Cannot write to /etc/resolv.conf (need sudo?)"
    exit 1
fi
