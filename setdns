#!/bin/sh
# setdns.sh - set DNS servers on the active NetworkManager connection (safe: will not modify hotspot/AP connections)
set -e

usage() {
  cat <<EOF
Usage: $0 <dns1[,dns2,...]>
Example: $0 1.1.1.1,8.8.8.8
If you pass '-' as the DNS list, the script will clear ipv4.dns and set ignore-auto-dns to no (use automatic).
EOF
  exit 1
}

[ $# -eq 1 ] || usage
DNS_LIST="$1"

# Find default interface
DEV=$(ip route get 1.1.1.1 2>/dev/null | awk '/dev/ {for(i=1;i<=NF;i++) if($i=="dev") {print $(i+1); exit}}')
[ -n "$DEV" ] || { echo "Could not detect default interface."; exit 1; }

# Find active connection bound to device
CONN=$(nmcli -t -f NAME,DEVICE connection show --active | awk -F: -v dev="$DEV" '$2==dev{print $1; exit}')

if [ -z "$CONN" ]; then
  # try any active connection
  CONN=$(nmcli -t -f NAME connection show --active | head -n1)
fi

if [ -z "$CONN" ]; then
  echo "No NetworkManager connection found. Will try to modify /etc/resolv.conf directly."
  if [ -w /etc/resolv.conf ]; then
    if [ "$DNS_LIST" = "-" ]; then
      printf "# setdns: revert to automatic (no DNS lines)\n" > /etc/resolv.conf
      echo "Cleared /etc/resolv.conf"
    else
      awk -v dns="$DNS_LIST" 'BEGIN{n=split(dns,a,","); for(i=1;i<=n;i++) print "nameserver " a[i]}' > /etc/resolv.conf
      echo "Wrote DNS to /etc/resolv.conf"
    fi
    exit 0
  else
    echo "No permission to write /etc/resolv.conf. Run as root or with sudo."
    exit 2
  fi
fi

# Detect if connection is a hotspot (AP mode)
APMODE=$(nmcli -g 802-11-wireless.mode connection show "$CONN" 2>/dev/null || true)
if [ "$APMODE" = "ap" ]; then
  echo "Connection '$CONN' appears to be a hotspot (802-11-wireless.mode=ap)."
  echo "Refusing to modify hotspot parameters. Falling back to /etc/resolv.conf."
  if [ -w /etc/resolv.conf ]; then
    if [ "$DNS_LIST" = "-" ]; then
      printf "# setdns fallback: revert to automatic (no DNS lines)\n" > /etc/resolv.conf
      echo "Cleared /etc/resolv.conf"
    else
      awk -v dns="$DNS_LIST" 'BEGIN{n=split(dns,a,","); for(i=1;i<=n;i++) print "nameserver " a[i]}' > /etc/resolv.conf
      echo "Wrote DNS to /etc/resolv.conf"
    fi
    exit 0
  else
    echo "No permission to write /etc/resolv.conf. Run as root or with sudo."
    exit 2
  fi
fi

# Modify only DNS keys
if [ "$DNS_LIST" = "-" ]; then
  echo "Clearing ipv4.dns and enabling automatic DNS (ignore-auto-dns no) on '$CONN'..."
  nmcli connection modify "$CONN" ipv4.dns "" ipv4.ignore-auto-dns no || { echo "Failed to modify connection (need privileges)"; exit 3; }
else
  echo "Setting ipv4.dns='$DNS_LIST' and ipv4.ignore-auto-dns=yes on '$CONN'..."
  nmcli connection modify "$CONN" ipv4.dns "$DNS_LIST" ipv4.ignore-auto-dns yes || { echo "Failed to modify connection (need privileges)"; exit 3; }
fi

nmcli connection up "$CONN" >/dev/null 2>&1 || echo "Warning: bringing connection up failed; NetworkManager may apply changes later."
echo "Done."
